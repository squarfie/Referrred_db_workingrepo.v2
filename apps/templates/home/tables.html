{% extends 'layouts/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %} View Records {% endblock title %}

{% block stylesheets %}
  <link rel="stylesheet" href="{% static 'assets/css/arsp.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/header.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/settings.css' %}">
{% endblock stylesheets %}

{% block content %}

<!-- Animated Header -->
<div class="header-container">
  <div class="background-animation-wrapper" aria-hidden="true">
    <!-- Grid Background -->
    <div class="grid-bg"></div>

    <!-- Rising Particles -->
    <div class="particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>

    <!-- Scanners -->
    <div class="scanner"></div>
    <div class="scanner"></div>
    <div class="scanner"></div>

    <!-- Glow Orbs -->
    <div class="glow-orb"></div>
    <div class="glow-orb"></div>

    <!-- Gradient Overlay -->
    <div class="overlay"></div>
  </div>

  <!-- Header Content -->
  <div class="header-content">
    <h1>
      <i class="fas fa-database mr-2"></i>View Records
    </h1>
    <p>View, search, and manage all laboratory records</p>
    <div class="badge-group">
      <span class="badge">
        <i class="badge-icon fas fa-flask"></i>
        {{ page_obj.paginator.count }} Total Records
      </span>
      <span class="badge">
        <i class="badge-icon fas fa-list"></i>
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
    </div>
  </div>
</div>

<!-- Page Content -->
<div class="container-fluid mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-12 col-md-12">
      <!-- Main Card -->
      <div class="form-card">
        <!-- Header with Action Buttons -->
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <h4 class="mb-0">
            <i class="fas fa-table mr-2"></i>Records Table
          </h4>
          <div class="d-flex gap-2 flex-wrap">
            <a class="btn btn-primary btn-sm" href="{% url 'batch_create_view' %}" title="Create a new batch">
              <i class="fas fa-plus mr-1"></i>Add New Batch
            </a>
            <a class="btn btn-secondary btn-sm" href="{% url 'review_batches' %}" title="Review existing batches">
              <i class="fas fa-check-circle mr-1"></i>Review Batches
            </a>
            <a class="btn btn-info btn-sm" href="{% url 'abxentry_view' %}" title="Enter antibiotic results">
              <i class="fas fa-microscope mr-1"></i>Antibiotic Results
            </a>
          </div>
        </div>

        <div class="card-body">
          <!-- Search Bar -->
          <div class="search-controls">
            <form method="get" class="row align-items-center gy-3">
              <div class="col-lg-8 col-md-12">
                <div class="search-box">
                  <i class="fas fa-search search-icon"></i>
                  <input
                    type="text"
                    name="q"
                    id="globalSearch"
                    value="{{ query|default:'' }}"
                    class="form-control"
                    placeholder="Search: Accession No, Patient Name, Specimen Type..."
                  >
                </div>

                {% if query %}
                <div class="search-results-info">
                  <i class="fas fa-info-circle mr-1"></i>Showing results for: <strong>{{ query }}</strong>
                </div>
                {% endif %}
              </div>

              <div class="col-lg-4 col-md-12 d-flex gap-2 justify-content-lg-end">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1 flex-lg-grow-0">
                  <i class="fas fa-search mr-1"></i>Search
                </button>
                <button type="button" class="btn btn-secondary btn-sm flex-grow-1 flex-lg-grow-0" onclick="clearSearch()">
                  <i class="fas fa-redo mr-1"></i>Reset
                </button>
              </div>
            </form>
          </div>

          <!-- Table -->
          <div class="table-responsive">
            <table class="table table-hover align-items-center mb-0">
              <thead class="table-dark">
                <tr>
                  <th class="text-center">
                    <i class="fas fa-cogs mr-1"></i>ACTION
                  </th>
                  <th class="text-center">
                    <i class="fas fa-check mr-1"></i>COPIED
                  </th>

                  <th colspan="2" class="cursor-pointer">
                    <a href="?sort=AccessionNo&order={% if current_sort == 'AccessionNo' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">
                      <i class="fas fa-id-card mr-1"></i>Identification
                      {% if current_sort == 'AccessionNo' %}
                        <i class="fas fa-arrow-{% if current_order == 'asc' %}up{% else %}down{% endif %} ml-1"></i>
                      {% endif %}
                    </a>
                  </th>

                  <th colspan="2" class="cursor-pointer">
                    <a href="?sort=First_Name&order={% if current_sort == 'First_Name' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">
                      <i class="fas fa-user mr-1"></i>Patient Details
                      {% if current_sort == 'First_Name' %}
                        <i class="fas fa-arrow-{% if current_order == 'asc' %}up{% else %}down{% endif %} ml-1"></i>
                      {% endif %}
                    </a>
                  </th>

                  <th colspan="2" class="cursor-pointer">
                    <a href="?sort=Spec_Type&order={% if current_sort == 'Spec_Type' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">
                      <i class="fas fa-flask mr-1"></i>Specimen Details
                      {% if current_sort == 'Spec_Type' %}
                        <i class="fas fa-arrow-{% if current_order == 'asc' %}up{% else %}down{% endif %} ml-1"></i>
                      {% endif %}
                    </a>
                  </th>

                  <th class="cursor-pointer">
                    <a href="?sort=Date_of_Entry&order={% if current_sort == 'Date_of_Entry' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">
                      <i class="fas fa-calendar mr-1"></i>Date Modified
                      {% if current_sort == 'Date_of_Entry' %}
                        <i class="fas fa-arrow-{% if current_order == 'asc' %}up{% else %}down{% endif %} ml-1"></i>
                      {% endif %}
                    </a>
                  </th>

                  <th colspan="4">
                    <i class="fas fa-pills mr-1"></i>Antibiotic Results
                  </th>

                  <th class="text-center">
                    <i class="fas fa-print mr-1"></i>PRINT
                  </th>
                </tr>
              </thead>

              <tbody class="list">
                {% for isolate in page_obj %}
                <tr class="searchable-row"
                    data-search-text="{{ isolate.AccessionNo }} {{ isolate.First_Name }} {{ isolate.Last_Name }} {{ isolate.Spec_Type }}">

                  <!-- ACTION COLUMN -->
                  <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'edit_data' isolate.id %}" class="btn btn-outline-success" title="Edit this record">
                        <i class="fa fa-pencil-alt"></i>
                      </a>

                      <button type="button" class="btn btn-outline-danger delete-btn"
                              data-toggle="modal"
                              data-target="#deleteModal"
                              data-url="{% url 'delete_data' isolate.id %}"
                              title="Delete this record">
                        <i class="fa fa-trash"></i>
                      </button>

                      <button type="button" class="btn btn-outline-info"
                              onclick="if(confirm('Copy this isolate to Final Data?')) window.location.href='{% url 'copy_data_to_final' isolate.id %}'"
                              title="Copy to final data">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </td>

                  <!-- COPIED CHECK COLUMN -->
                  <td class="text-center">
                    <div class="form-check d-flex justify-content-center">
                      <input type="checkbox" class="form-check-input"
                        {% if isolate.AccessionNo in copied_ids %}checked{% endif %}
                        disabled>
                    </div>
                  </td>

                  <!-- IDENTIFICATION COLUMN -->
                  <td colspan="2">
                    <div class="record-info">
                      <div><strong class="text-primary">Batch:</strong> {{ isolate.Batch_Code }}</div>
                      <div><strong class="text-primary">Accession:</strong> {{ isolate.AccessionNo }}</div>
                      <div><strong class="text-primary">Referral Date:</strong> {{ isolate.Referral_Date }}</div>
                      <div><strong class="text-primary">Site:</strong> {{ isolate.SiteCode }}</div>
                    </div>
                  </td>

                  <!-- PATIENT COLUMN -->
                  <td colspan="2">
                    <div class="record-info">
                      <div><strong class="text-primary">Name:</strong> {{ isolate.First_Name }} {{ isolate.Last_Name }}</div>
                      <div><strong class="text-primary">ID:</strong> {{ isolate.Patient_ID }}</div>
                      <div><strong class="text-primary">Age:</strong> {{ isolate.Age }}</div>
                      <div><strong class="text-primary">Sex:</strong> {{ isolate.Sex }}</div>
                    </div>
                  </td>

                  <!-- SPECIMEN COLUMN -->
                  <td colspan="2">
                    <div class="record-info">
                      <div><strong class="text-primary">Date:</strong> {{ isolate.Spec_Date }}</div>
                      <div><strong class="text-primary">Admission:</strong> {{ isolate.Date_Admis }}</div>
                      <div><strong class="text-primary">Number:</strong> {{ isolate.Spec_Num }}</div>
                      <div><strong class="text-primary">Type:</strong> {{ isolate.Spec_Type }}</div>
                    </div>
                  </td>

                  <!-- DATE COLUMN -->
                  <td class="text-center">
                    <small class="text-muted">{{ isolate.Date_of_Entry|date:"M d, Y" }}</small>
                  </td>

                  <!-- ANTIBIOTICS COLUMN -->
                  <td colspan="4">
                    <div class="antibiotic-results small">
                      {% for antibiotic_entry in isolate.antibiotic_entries.all %}
                          {% if antibiotic_entry.ab_Disk_value %}
                            <div class="result-item">
                              <strong>{{ antibiotic_entry.ab_Antibiotic }}</strong>
                              <span class="text-muted">(Disk: {{ antibiotic_entry.ab_Disk_value }} {{ antibiotic_entry.ab_Disk_enRIS }})</span>
                              <span class="badge badge-danger">{{ antibiotic_entry.ab_Disk_RIS }}</span>
                            </div>
                          {% endif %}

                          {% if antibiotic_entry.ab_MIC_value %}
                            <div class="result-item">
                              <strong>{{ antibiotic_entry.ab_Antibiotic }}</strong>
                              <span class="text-muted">(MIC: {{ antibiotic_entry.ab_MIC_operand }} {{ antibiotic_entry.ab_MIC_value }} {{ antibiotic_entry.ab_MIC_enRIS }})</span>
                              <span class="badge badge-danger">{{ antibiotic_entry.ab_MIC_RIS }}</span>
                              {% if antibiotic_entry.ab_AlertMIC %}
                                <span class="badge badge-warning">Alert: {{ antibiotic_entry.ab_Alert_val }}</span>
                              {% endif %}
                            </div>
                          {% endif %}
                      {% empty %}
                        <small class="text-muted"><em>No Site Result</em>&nbsp;</small>
                      {% endfor %}

                      {% for retest_entry in isolate.antibiotic_entries.all %}
                          {% if retest_entry.ab_Retest_DiskValue %}
                            <div class="result-item">
                              <strong class="text-info">{{ retest_entry.ab_Retest_Antibiotic }}</strong>
                              <span class="text-muted">(ARS Disk: {{ retest_entry.ab_Retest_DiskValue }} {{ retest_entry.ab_Retest_Disk_enRIS }})</span>
                              <span class="badge badge-danger">{{ retest_entry.ab_Retest_Disk_RIS }}</span>
                            </div>
                          {% endif %}

                          {% if retest_entry.ab_Retest_MICValue %}
                            <div class="result-item">
                              <strong class="text-info">{{ retest_entry.ab_Retest_Antibiotic }}</strong>
                              <span class="text-muted">(ARS MIC: {{ retest_entry.ab_Retest_MIC_operand }} {{ retest_entry.ab_Retest_MICValue }} {{ retest_entry.ab_Retest_MIC_enRIS }})</span>
                              <span class="badge badge-danger">{{ retest_entry.ab_Retest_MIC_RIS }}</span>
                              {% if retest_entry.ab_Retest_AlertMIC %}
                                <span class="badge badge-warning">Alert: {{ retest_entry.ab_Retest_Alert_val }}</span>
                              {% endif %}
                            </div>
                          {% endif %}
                      {% empty %}
                        <small class="text-muted"><em>No ARS Result</em></small>
                      {% endfor %}
                    </div>
                  </td>

                  <!-- PRINT COLUMN -->
                  <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'generate_pdf' isolate.id %}" class="btn btn-outline-info" title="Generate Lab Result PDF">
                        <i class="fa fa-file-pdf"></i>
                      </a>
                      <a href="{% url 'generate_gs' isolate.id %}" class="btn btn-outline-success" title="Generate Gram Stain">
                        <i class="fa fa-microscope"></i>
                      </a>
                    </div>
                  </td>

                </tr>
                {% endfor %}

              </tbody>

            </table>

            {% if not page_obj %}
            <div class="alert alert-info text-center mt-4">
              <i class="fas fa-info-circle mr-2"></i>
              No records found. Try adjusting your search criteria.
            </div>
            {% endif %}
          </div>


    <!-- Card Footer with Pagination -->
    <div class="card-footer py-4 bg-light">
      <div class="row align-items-center">
        <!-- Go To Page Form -->
        <div class="col-md-4">
          <form method="get" class="form-inline">
            <label class="mr-2 mb-0 text-primary">Go to page:</label>
            <input type="number" name="page"
                   min="1"
                   max="{{ page_obj.paginator.num_pages }}"
                   value="{{ page_obj.number }}"
                   class="form-control form-control-sm mr-2"
                   style="width: 70px;">
            <button type="submit" class="btn btn-sm btn-primary">
              <i class="fas fa-arrow-right"></i>
            </button>
          </form>
        </div>

        <!-- Page Info -->
        <div class="col-md-4 text-center">
          <span class="text-primary">
            Page <strong>{{ page_obj.number }}</strong> of <strong>{{ page_obj.paginator.num_pages }}</strong>
          </span>
        </div>

        <!-- Pagination Controls -->
        <div class="col-md-4">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-end mb-0">
              <!-- First Page -->
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1" title="First page">
                    <i class="fas fa-angle-double-left"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                </li>
              {% endif %}

              <!-- Previous -->
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}" title="Previous page">
                    <i class="fas fa-angle-left"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-angle-left"></i></span>
                </li>
              {% endif %}

              <!-- Page Numbers -->
              {% for num in page_obj.paginator.page_range %}
                {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                  {% if num == page_obj.number %}
                    <li class="page-item active">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endif %}
              {% endfor %}

              <!-- Next -->
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}" title="Next page">
                    <i class="fas fa-angle-right"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-angle-right"></i></span>
                </li>
              {% endif %}

              <!-- Last Page -->
              {% if page_obj.number < page_obj.paginator.num_pages %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" title="Last page">
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h6 class="modal-title" id="deleteModalLabel">
          <i class="fa fa-exclamation-triangle mr-2"></i>Delete Confirmation
        </h6>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <h5>Are you sure you want to delete this record?</h5>
        <p class="text-muted mb-0">
          <i class="fas fa-info-circle mr-2"></i>
          This action cannot be undone. All associated data will be permanently removed.
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fa fa-times mr-2"></i>Cancel
        </button>
        <a id="confirmDeleteBtn" href="#" class="btn btn-danger">
          <i class="fa fa-trash mr-2"></i>Delete Record
        </a>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
  // Delete button modal
  $('.delete-btn').on('click', function() {
    $('#confirmDeleteBtn').attr('href', $(this).data('url'));
  });

  // Clear search functionality
  function clearSearch() {
    document.getElementById("globalSearch").value = "";
    document.querySelectorAll(".searchable-row").forEach(r => r.style.display = "");
    // Optional: Reset the form
    document.querySelector('form').submit();
  }

  // Add some styling improvements
  document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to table rows
    const rows = document.querySelectorAll('.searchable-row');
    rows.forEach(row => {
      row.addEventListener('mouseenter', function() {
        this.style.backgroundColor = 'rgba(0, 188, 212, 0.05)';
      });
      row.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
      });
    });
  });
</script>
{% endblock javascripts %}